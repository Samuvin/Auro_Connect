name: üöÄ Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      skip_lint:
        description: 'Skip Linting'
        required: false
        default: false
        type: boolean
      skip_unit_tests:
        description: 'Skip Unit Tests'
        required: false
        default: false
        type: boolean
      skip_performance_tests:
        description: 'Skip Performance Tests'
        required: false
        default: false
        type: boolean
      skip_e2e_tests:
        description: 'Skip End-to-End Tests'
        required: false
        default: false
        type: boolean
      skip_integration_tests:
        description: 'Skip Integration Tests'
        required: false
        default: false
        type: boolean
      update_visual_snapshots:
        description: 'Update Visual Snapshots'
        required: false
        default: false
        type: boolean
      playwright_workers:
        description: 'Number of Playwright workers'
        required: false
        default: '11'
        type: string
      playwright_browsers:
        description: 'Browsers to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - chromium
          - firefox
          - webkit
      playwright_devices:
        description: 'Device types to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - desktop
          - mobile
          - tablet
      playwright_retries:
        description: 'Number of test retries'
        required: false
        default: '2'
        type: string

permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: '18'
  
jobs:
  setup:
    name: üîß Setup & Dependencies
    uses: ./.github/workflows/setup.yml
    
  lint:
    name: üîç Lint & Code Quality
    needs: setup
    if: github.event.inputs.skip_lint != 'true'
    uses: ./.github/workflows/lint.yml
    with:
      node-version: '18'
      
  test:
    name: üß™ Tests
    needs: [setup, lint]
    if: always()
    uses: ./.github/workflows/test.yml
    with:
      node-version: '18'
      skip-unit-tests: ${{ github.event.inputs.skip_unit_tests == 'true' }}
      skip-integration-tests: ${{ github.event.inputs.skip_integration_tests == 'true' }}
      
  visual_regression:
    name: üëÅÔ∏è Visual Regression
    needs: [setup, lint]
    if: always()
    uses: ./.github/workflows/visual-regression.yml
    with:
      node-version: '18'
      skip-visual-tests: false
      playwright-workers: '1'
      playwright-browsers: ${{ github.event.inputs.playwright_browsers || 'all' }}
      update-snapshots: ${{ github.event.inputs.update_visual_snapshots == 'true' }}
        
  performance:
    name: ‚ö° Performance & E2E
    needs: [setup, lint, test, visual_regression]
    if: always()
    uses: ./.github/workflows/performance.yml
    with:
      node-version: '18'
      skip-performance-tests: ${{ github.event.inputs.skip_performance_tests == 'true' }}
      skip-e2e-tests: ${{ github.event.inputs.skip_e2e_tests == 'true' }}
      playwright-workers: ${{ github.event.inputs.playwright_workers || '11' }}
      playwright-browsers: ${{ github.event.inputs.playwright_browsers || 'all' }}
      playwright-devices: ${{ github.event.inputs.playwright_devices || 'all' }}
      playwright-retries: ${{ github.event.inputs.playwright_retries || '2' }}
      
  report:
    name: üìä Test Summary & Reporting
    needs: [setup, lint, test, visual_regression, performance]
    if: always()
    uses: ./.github/workflows/report.yml
    with:
      node-version: '18'
      setup-result: ${{ needs.setup.result }}
      lint-result: ${{ needs.lint.result }}
      test-result: ${{ needs.test.result }}
      visual-regression-result: ${{ needs.visual-regression.result }}
      performance-result: ${{ needs.performance.result }}
    secrets:
      slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
      slack-token: ${{ secrets.SLACK_TOKEN }}
      slack-channel: ${{ secrets.SLACK_CHANNEL }} 
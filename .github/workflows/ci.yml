name: ğŸ”„ Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      SkipLinting:
        description: 'Skip Linting'
        required: false
        default: false
        type: boolean
      SkipUnitTests:
        description: 'Skip Unit Tests'
        required: false
        default: false
        type: boolean
      SkipE2ETests:
        description: 'Skip End-to-End Tests'
        required: false
        default: false
        type: boolean
      SkipPerformanceTests:
        description: 'Skip Performance Tests'
        required: false
        default: false
        type: boolean
      SkipBuild:
        description: 'Skip Application Build'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}

jobs:
  # Stage: Install Dependencies
  install-dependencies:
    name: ğŸ“¦ Install Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”¨ Install Dependencies
        run: |
          npm ci
          cd frontend && npm ci && npx playwright install
          cd ../backend && npm ci

      - name: ğŸ“¢ Slack Success Notification
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' -H 'Authorization: Bearer ${{ env.SLACK_TOKEN }}' --data "{
            \"channel\": \"#auro-connect\",
            \"text\": \"âœ… Install Dependencies - SUCCESS\",
            \"color\": \"good\"
          }" https://slack.com/api/chat.postMessage

      - name: ğŸ“¢ Slack Failure Notification
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' -H 'Authorization: Bearer ${{ env.SLACK_TOKEN }}' --data "{
            \"channel\": \"#auro-connect\",
            \"text\": \"âŒ Install Dependencies - FAILED\",
            \"color\": \"danger\"
          }" https://slack.com/api/chat.postMessage

  # Stage: Parallel - Lint & Code Quality
  lint:
    name: ğŸ” Lint & Code Quality
    runs-on: ubuntu-latest
    needs: install-dependencies
    if: github.event.inputs.SkipLinting != 'true'
    strategy:
      fail-fast: false
      matrix:
        component: [backend, frontend]
    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”¨ Install Dependencies
        working-directory: ${{ matrix.component }}
        run: npm ci

      - name: ğŸ” Run Linting
        working-directory: ${{ matrix.component }}
        run: npm run lint:check || echo "âŒ ${{ matrix.component }} linting failed but continuing..."
        continue-on-error: true

      - name: ğŸ“¢ Slack Success Notification
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' -H 'Authorization: Bearer ${{ env.SLACK_TOKEN }}' --data "{
            \"channel\": \"#auro-connect\",
            \"text\": \"âœ… ${{ matrix.component }} Lint - SUCCESS\",
            \"color\": \"good\"
          }" https://slack.com/api/chat.postMessage

      - name: ğŸ“¢ Slack Failure Notification
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' -H 'Authorization: Bearer ${{ env.SLACK_TOKEN }}' --data "{
            \"channel\": \"#auro-connect\",
            \"text\": \"âŒ ${{ matrix.component }} Lint - FAILED\",
            \"color\": \"danger\"
          }" https://slack.com/api/chat.postMessage

  # Stage: Parallel - Unit & Integration Tests
  unit-tests:
    name: ğŸ§ª Unit & Integration Tests
    runs-on: ubuntu-latest
    needs: [install-dependencies, lint]
    if: always() && github.event.inputs.SkipUnitTests != 'true'
    strategy:
      fail-fast: false
      matrix:
        component: [backend, frontend]
    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”¨ Install Dependencies
        working-directory: ${{ matrix.component }}
        run: npm ci

      - name: ğŸ§ª Run Tests
        working-directory: ${{ matrix.component }}
        run: |
          if [ "${{ matrix.component }}" = "frontend" ]; then
            npm run test:ci || echo "âŒ Frontend tests failed but continuing..."
          else
            npm run test:coverage || echo "âŒ Backend tests failed but continuing..."
          fi
        continue-on-error: true

      - name: ğŸ“Š Archive Coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.component }}
          path: ${{ matrix.component }}/coverage/
          retention-days: 30

      - name: ğŸ“¢ Slack Success Notification
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' -H 'Authorization: Bearer ${{ env.SLACK_TOKEN }}' --data "{
            \"channel\": \"#auro-connect\",
            \"text\": \"âœ… ${{ matrix.component }} Tests - SUCCESS\",
            \"color\": \"good\"
          }" https://slack.com/api/chat.postMessage

      - name: ğŸ“¢ Slack Failure Notification
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' -H 'Authorization: Bearer ${{ env.SLACK_TOKEN }}' --data "{
            \"channel\": \"#auro-connect\",
            \"text\": \"âŒ ${{ matrix.component }} Tests - FAILED\",
            \"color\": \"danger\"
          }" https://slack.com/api/chat.postMessage

  # Stage: End-to-End Tests
  e2e-tests:
    name: ğŸ­ End-to-End Tests
    runs-on: ubuntu-latest
    needs: [install-dependencies, lint, unit-tests]
    if: always() && github.event.inputs.SkipE2ETests != 'true'
    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”¨ Install Dependencies
        run: |
          npm ci
          cd frontend && npm ci && npx playwright install
          cd ../backend && npm ci

      - name: ğŸš€ Start Backend Server
        working-directory: backend
        run: |
          nohup npm start > ../backend.log 2>&1 & echo $! > ../backend.pid

      - name: ğŸŒ Start Frontend Server
        working-directory: frontend
        run: |
          nohup npm run preview > ../frontend.log 2>&1 & echo $! > ../frontend.pid

      - name: â³ Wait for Servers
        run: sleep 10

      - name: ğŸ­ Run E2E Tests
        working-directory: frontend
        run: npm run test:e2e:ci || echo "âŒ E2E tests failed but continuing..."
        continue-on-error: true

      - name: ğŸ§¹ Cleanup Servers
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) || true
            rm backend.pid
          fi
          if [ -f frontend.pid ]; then
            kill $(cat frontend.pid) || true
            rm frontend.pid
          fi

      - name: ğŸ“Š Archive E2E Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            frontend/test-results/
            frontend/playwright-report/
            backend.log
            frontend.log
          retention-days: 30

      - name: ğŸ“¢ Slack Success Notification
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' -H 'Authorization: Bearer ${{ env.SLACK_TOKEN }}' --data "{
            \"channel\": \"#auro-connect\",
            \"text\": \"âœ… End-to-End Tests - SUCCESS\",
            \"color\": \"good\"
          }" https://slack.com/api/chat.postMessage

      - name: ğŸ“¢ Slack Failure Notification
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' -H 'Authorization: Bearer ${{ env.SLACK_TOKEN }}' --data "{
            \"channel\": \"#auro-connect\",
            \"text\": \"âŒ End-to-End Tests - FAILED\",
            \"color\": \"danger\"
          }" https://slack.com/api/chat.postMessage

  # Stage: Performance Tests
  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: [install-dependencies, lint, unit-tests, e2e-tests]
    if: always() && github.event.inputs.SkipPerformanceTests != 'true'
    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ”¨ Install Dependencies
        run: |
          npm ci
          cd frontend && npm ci && npx playwright install
          cd ../backend && npm ci

      - name: ğŸš€ Start Backend Server
        working-directory: backend
        run: |
          nohup npm start > ../backend-perf.log 2>&1 & echo $! > ../backend-perf.pid

      - name: ğŸŒ Start Frontend Server
        working-directory: frontend
        run: |
          nohup npm run preview > ../frontend-perf.log 2>&1 & echo $! > ../frontend-perf.pid

      - name: â³ Wait for Servers
        run: sleep 15

      - name: ğŸ­ Run Performance Tests
        working-directory: frontend
        run: npm run test:perf:ci || echo "âŒ Performance tests failed but continuing..."
        continue-on-error: true

      - name: ğŸ” Run Lighthouse Tests
        working-directory: frontend
        run: npm run test:lighthouse:ci || echo "âŒ Lighthouse tests failed but continuing..."
        continue-on-error: true

      - name: ğŸ§  Run Memory Leak Tests
        working-directory: frontend
        run: npm run test:memory-leaks:ci || echo "âŒ Memory leak tests failed but continuing..."
        continue-on-error: true

      - name: ğŸ§¹ Cleanup Servers
        if: always()
        run: |
          if [ -f backend-perf.pid ]; then
            kill $(cat backend-perf.pid) || true
            rm backend-perf.pid
          fi
          if [ -f frontend-perf.pid ]; then
            kill $(cat frontend-perf.pid) || true
            rm frontend-perf.pid
          fi

      - name: ğŸ“Š Archive Performance Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-results
          path: |
            frontend/lighthouse-reports/
            backend-perf.log
            frontend-perf.log
          retention-days: 30

      - name: ğŸ“¢ Slack Success Notification
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' -H 'Authorization: Bearer ${{ env.SLACK_TOKEN }}' --data "{
            \"channel\": \"#auro-connect\",
            \"text\": \"âœ… Performance Tests - SUCCESS\",
            \"color\": \"good\"
          }" https://slack.com/api/chat.postMessage

      - name: ğŸ“¢ Slack Failure Notification
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' -H 'Authorization: Bearer ${{ env.SLACK_TOKEN }}' --data "{
            \"channel\": \"#auro-connect\",
            \"text\": \"âŒ Performance Tests - FAILED\",
            \"color\": \"danger\"
          }" https://slack.com/api/chat.postMessage

  # Stage: Test Summary
  test-summary:
    name: ğŸ“‹ Test Summary
    runs-on: ubuntu-latest
    needs: [install-dependencies, lint, unit-tests, e2e-tests, performance-tests]
    if: always()
    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“Š Generate Test Summary
        run: |
          echo "=== Test Summary ==="
          echo "Install Dependencies Status: ${{ needs.install-dependencies.result }}"
          echo "Lint Status: ${{ needs.lint.result }}"
          echo "Unit Tests Status: ${{ needs.unit-tests.result }}"
          echo "E2E Tests Status: ${{ needs.e2e-tests.result }}"
          echo "Performance Tests Status: ${{ needs.performance-tests.result }}"
          
          # Set final result like Jenkins - only fail if critical tests fail
          if [[ "${{ needs.install-dependencies.result }}" == "failure" ]]; then
            echo "âŒ Critical failure - cannot continue without dependencies"
            exit 1
          elif [[ "${{ needs.unit-tests.result }}" == "failure" || "${{ needs.e2e-tests.result }}" == "failure" || "${{ needs.performance-tests.result }}" == "failure" || "${{ needs.lint.result }}" == "failure" ]]; then
            echo "ğŸŸ¡ Build completed with some test failures"
            # Don't exit 1 - Jenkins sets UNSTABLE, not FAILURE
          else
            echo "âœ… All tests passed successfully"
          fi

      - name: ğŸ“Š Archive Combined Coverage
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          merge-multiple: true

      - name: ğŸ“¦ Upload Combined Coverage
        uses: actions/upload-artifact@v4
        with:
          name: combined-coverage
          path: coverage/
          retention-days: 30

      - name: ğŸ“¢ Slack Final Summary - Success
        if: needs.install-dependencies.result == 'success' && needs.lint.result != 'failure' && needs.unit-tests.result != 'failure' && needs.e2e-tests.result != 'failure' && needs.performance-tests.result != 'failure'
        run: |
          curl -X POST -H 'Content-type: application/json' -H 'Authorization: Bearer ${{ env.SLACK_TOKEN }}' --data "{
            \"channel\": \"#auro-connect\",
            \"text\": \"âœ… CI Pipeline COMPLETED SUCCESSFULLY\\nCommit: ${{ github.sha }}\\nBranch: ${{ github.ref_name }}\\nAuthor: ${{ github.actor }}\",
            \"color\": \"good\"
          }" https://slack.com/api/chat.postMessage

      - name: ğŸ“¢ Slack Final Summary - Unstable
        if: needs.install-dependencies.result != 'failure' && (needs.lint.result == 'failure' || needs.unit-tests.result == 'failure' || needs.e2e-tests.result == 'failure' || needs.performance-tests.result == 'failure')
        run: |
          curl -X POST -H 'Content-type: application/json' -H 'Authorization: Bearer ${{ env.SLACK_TOKEN }}' --data "{
            \"channel\": \"#auro-connect\",
            \"text\": \"ğŸŸ¡ CI Pipeline COMPLETED WITH FAILURES\\nCommit: ${{ github.sha }}\\nBranch: ${{ github.ref_name }}\\nAuthor: ${{ github.actor }}\\nCheck: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
            \"color\": \"warning\"
          }" https://slack.com/api/chat.postMessage

      - name: ğŸ“¢ Slack Final Summary - Failure
        if: needs.install-dependencies.result == 'failure'
        run: |
          curl -X POST -H 'Content-type: application/json' -H 'Authorization: Bearer ${{ env.SLACK_TOKEN }}' --data "{
            \"channel\": \"#auro-connect\",
            \"text\": \"âŒ CI Pipeline FAILED\\nCommit: ${{ github.sha }}\\nBranch: ${{ github.ref_name }}\\nAuthor: ${{ github.actor }}\\nCheck: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
            \"color\": \"danger\"
          }" https://slack.com/api/chat.postMessage 
name: Test Summary & Reporting

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: true
        type: string
      setup-result:
        description: 'Setup job result'
        required: false
        type: string
        default: 'success'
      lint-result:
        description: 'Lint job result'
        required: false
        type: string
        default: 'success'
      test-result:
        description: 'Test job result'
        required: false
        type: string
        default: 'success'
      visual-regression-result:
        description: 'Visual regression job result'
        required: false
        type: string
        default: 'success'
      performance-result:
        description: 'Performance job result'
        required: false
        type: string
        default: 'success'
    secrets:
      slack-webhook-url:
        description: 'Slack webhook URL for notifications'
        required: false
      slack-token:
        description: 'Slack bot token for notifications (alternative to webhook)'
        required: false
      slack-channel:
        description: 'Slack channel for notifications (used with bot token)'
        required: false

jobs:
  test-summary:
    name: ðŸ“Š Test Summary & Enhanced Reporting
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: ðŸ” Debug Artifacts Structure
        run: |
          echo "ðŸ“‚ Artifacts directory structure:"
          find artifacts/ -type f -name "*.log" -o -name "*.json" | head -20
          echo ""
          echo "ðŸŽ­ E2E test results:"
          if [ -f "artifacts/e2e-test-results/e2e-output.log" ]; then
            echo "âœ… E2E output log found"
            tail -10 artifacts/e2e-test-results/e2e-output.log
          else
            echo "âŒ E2E output log not found"
          fi
          echo ""
          echo "âš¡ Performance test results:"
          if [ -d "artifacts/performance-test-results/lighthouse-reports" ]; then
            echo "âœ… Lighthouse reports found"
            ls -la artifacts/performance-test-results/lighthouse-reports/
          else
            echo "âŒ Lighthouse reports not found"
          fi

      - name: ðŸ“Š Generate Comprehensive Test Summary
        run: |
          echo "# ðŸ“Š Comprehensive CI Pipeline Report" > test-summary.md
          echo "" >> test-summary.md
          echo "## ðŸ” Pipeline Overview" >> test-summary.md
          echo "- **Commit:** \`${{ github.sha }}\`" >> test-summary.md
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> test-summary.md
          echo "- **Author:** ${{ github.actor }}" >> test-summary.md
          echo "- **Triggered by:** ${{ github.event_name }}" >> test-summary.md
          echo "- **Workflow:** ${{ github.workflow }}" >> test-summary.md
          echo "" >> test-summary.md
          
          echo "## ðŸ“‹ Job Results" >> test-summary.md
          echo "- **Setup:** ${{ inputs.setup-result }}" >> test-summary.md
          echo "- **Lint:** ${{ inputs.lint-result }}" >> test-summary.md
          echo "- **Tests:** ${{ inputs.test-result }}" >> test-summary.md
          echo "- **Performance:** ${{ inputs.performance-result }}" >> test-summary.md

      - name: ðŸ“¤ Send Enhanced Slack Notification
        if: always()
        run: |
          # Make script executable and run Slack notification
          chmod +x ./scripts/send-slack-notification.sh
          ./scripts/send-slack-notification.sh
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.slack-webhook-url }}
          SLACK_TOKEN: ${{ secrets.slack-token }}
          SLACK_CHANNEL: ${{ secrets.slack-channel }}
          GITHUB_CONTEXT: ${{ toJson(github) }}
          SETUP_RESULT: ${{ inputs.setup-result }}
          LINT_RESULT: ${{ inputs.lint-result }}
          TEST_RESULTS: ${{ inputs.test-result }}
          PERFORMANCE_RESULTS: ${{ inputs.performance-result }}

      - name: ðŸ“¤ Upload Enhanced Test Summary
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-test-summary
          path: |
            test-summary.md
            slack_api_message.json
            slack_webhook_message.json
          retention-days: 30 